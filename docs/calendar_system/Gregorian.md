# グレゴリオ暦カレンダー実装仕様

## グレゴリオ暦の特徴
- 平年 365 日・閏年 366 日の太陽暦で、400 年サイクルで 97 回の閏年を持つ規則を採用しています。
- 本リポジトリの `GregorianCalendar` は **先発 (proleptic)** グレゴリオ暦を採用しており、BC 年を含むあらゆる年数に対してグレゴリオ暦の規則を遡及適用します。
- 内部表現は連続シリアル日 (Unix epoch 1970-01-01 を 0) を使用し、`Date` クラスと共通の基準で相互運用できます。
- `Era` は `BC`/`AD` の 2 種を持ち、年号 0 は存在しません (BC 1 年の次は AD 1 年)。

## 実装構成
### 日付計算ロジック
- `GregorianCalendar::to_serial_date`/`from_serial_date` は Howard Hinnant のアルゴリズムをベースに、O(1) の算術のみでシリアル日と年月日の相互変換を行います。
- 閏年判定 `is_leap(year)` と `last_day_of_month(year, month)` で日付の妥当性を事前検証し、月ごとの日数 (2 月の 29 日対応) を厳密にチェックします。
- シリアル日→曜日は `serial_date` の剰余演算で求め、`0=Sun .. 6=Sat` を返します。

### フォーマット/パース機構
- `to_serial_date(const std::string&, const char*, bool)` は再帰 descent でフォーマット文字列と入力を同時に走査し、`%E/%Y/%M/%D/%W` (大小含む)・`%%` を解析します。
- 大文字指定子 (`%Y`, `%M`, `%D`) は可変長数値 (ゼロ埋めなし) を、⼩文字指定子 (`%y`, `%m`, `%d`) は 2 桁固定 (ゼロ埋めあり) を読み取ります。
- `strict` フラグは **曖昧解釈の扱い** を切り替えます。`strict=true` (既定) では複数の解釈が得られると例外を送出し、`strict=false` では貪欲に最初に成功した解釈をそのまま採用します。書式中のリテラルや空白は常に完全一致が必要で、末尾空白の自動トリム等は行いません。
- `from_serial_date(..., const char* format)` は同じ指定子集合を使って文字列を生成し、曜日文字列 (`%W/%w`) もサポートします。

### 主なクラス
- `GregorianCalendar` は `ICalendarSystem` を実装するプロレプティック版グレゴリオ暦です。`Date` クラスの `CalendarSystem::GREGORIAN` から使用されます。
- `NonProlepticGregorianCalendar` は 1582-10-15 以前を許可しない実装で、内部的に `GregorianCalendar` の計算を使いつつ `validate_serial_date` により 1582-10-04 の次を 1582-10-15 とみなすギャップを強制します。歴史的日付を正確に扱いたい場合はこちらを利用してください (フォーマット指定子や `strict` の挙動は共通です)。

## 実装しているもの
- 1582 年以前を含む全期間の双方向変換 (BC/AD)。
- 閏年規則と月末チェックによる厳密な入力検証。
- フォーマット指定子 `%E/%e`, `%Y/%y`, `%M/%m`, `%D/%d`, `%W/%w`, `%%`。
- 曜日名の長短 2 種類 (例: `%W` → "Monday", `%w` → "Mon.")。
- `strict` フラグによるパース方針切替、曖昧一致の検出 (`strict=true` の既定値では複数候補がある場合に例外を投げ、`strict=false` は最初に見つけた候補を返します)。
- BC 年入力時に `year=1` が BC1、`year=2` が BC2 として扱われ、内部では 0 年を持たないよう補正。

## 未実装 / 制限事項
- ロケール依存の月名・曜日名、序数表示、ISO 週番号などの書式指定子は未サポートです。
- タイムゾーンや時刻要素 (時・分・秒) は扱っていません。日単位のみです。
- `strict=false` でもリテラルのゆらぎ (ハイフン→スラッシュなど) や不要な空白は許可されません。フォーマット通りの文字列を準備してください。
- パース時のローマ数字、西暦を示す別表記 (例えば "CE" や "BCE") には対応していません。
- 先発グレゴリオ暦のため、歴史的には存在しない BC の日付も計算できます。史実再現が必要な場合は別ロジックを検討してください。

## 使い方
### `Date` 経由
```cpp
#include <Date.hpp>
// 2025-03-31 を生成して和暦や他暦と変換
toolbox::Date d(toolbox::GREGORIAN,
	toolbox::GregorianCalendar::AD, 2025, 3, 31);

std::string iso = d.to_string(toolbox::GREGORIAN, "%Y-%m-%d");
std::string weekday = d.to_string(toolbox::GREGORIAN, "%W");
// 他暦へ変換
std::string wareki = d.to_string(toolbox::JAPANESE_WAREKI, "%E%Y年%m月%d日");
```

### `GregorianCalendar` を直接利用
```cpp
#include <calendar_system/GregorianCalendar.hpp>

toolbox::GregorianCalendar cal;

// AD 2024-02-29 → シリアル日
int serial = cal.to_serial_date(toolbox::GregorianCalendar::AD,
							   2024, 2, 29);

// フォーマット付きパース (BC 31 年 12 月 1 日)
serial = cal.to_serial_date("B.C.31-12-01", "%E%Y-%m-%d", true);

// 文字列生成 (曜日付き)
std::string out;
cal.from_serial_date(serial, out, "%Y/%m/%d (%w)");

// 曜日だけ取得
int dow;
cal.from_serial_date(serial, dow);  // 0=Sun .. 6=Sat
```

## フォーマット仕様
| 指定子 | 入力/出力 | 説明 |
| --- | --- | --- |
| `%E` / `%e` | 双方向 | `BC`/`AD` を表す。`%E` は "B.C."/"A.D.", `%e` は "BC"/"AD" |
| `%Y` | 双方向 | 年 (可変長、ゼロ埋めなし)。BC の場合も正の整数で入力。 |
| `%y` | 双方向 | 年の下 2 桁、ゼロ埋め 2 桁。 |
| `%M` | 双方向 | 月 (1–12、可変長)。 |
| `%m` | 双方向 | 月 (2 桁ゼロ埋め)。 |
| `%D` | 双方向 | 日 (可変長)。 |
| `%d` | 双方向 | 日 (2 桁ゼロ埋め)。 |
| `%W` | 出力のみ | 曜日フルスペル (Sunday..Saturday)。 |
| `%w` | 出力のみ | 曜日省略形 (Sun..Sat)。 |
| `%%` | 双方向 | 文字 `%` をそのまま扱う。 |

- パース時、書式内のリテラル (例: `-`, `/`, 空白) は完全一致が必要です。
- 大文字指定子は可変長のため、後続のリテラルで区切ることを推奨します。`strict=true` では複数解が生じた場合に例外が発生します。

## 特殊処理と注意事項
- **年 0 不許可**: AD/BC いずれも year=0 を指定すると例外になります。BC 年を扱う際は 1 から始めてください。
- **1582 年のギャップ**: 先発仕様のため、実歴史で存在しない 1582-10-05〜14 も連続したシリアル日として扱われます。史実通りの欠落を再現したい場合は `NonProlepticGregorianCalendar` を使用します。
- **曖昧な書式**: `%Y%m%d` のように区切りなしで入力すると、可変長指定子が複数マッチする場合があります。`strict=true` であれば曖昧さを検出して例外を投げ、`strict=false` では最初に成功した解釈 (例: 月=11/日=12 か月=1/日=12 など) が返されます。
- **曜日計算**: `from_serial_date(serial, day_of_week)` は負のシリアル値 (BC 年) にも対応するよう、剰余計算で補正しています。
- **例外メッセージ**: 入力検証失敗時には、エラーメッセージに原因 (無効な era・月範囲・日範囲など) が含まれるため、そのままユーザーに提示できます。

## 改変・拡張のヒント
- **追加フォーマット指定子**: 月名や ISO 週番号をサポートするには、`to_string_*`/`parse_*` 系のヘルパーと switch を拡張します。
- **ロケール対応**: 曜日・月名をロケール別に切り替えたい場合、`to_string_Ww` 等を差し替える戦略クラスを導入するのが簡潔です。
- **精度検証**: 大きな年数 (±1,000,000 年など) でもアルゴリズムが溢れないか確認するため、`int64_t` 化やチェックを追加する余地があります。
- **パース高速化**: 再帰を iterative に置き換えたり、`strict=false` 用の早期終了条件を調整すれば、大量パース時のコストを削減できます。

## テスト観点
- 閏年境界: 1900 (平年) / 2000 (閏年) / 2100 (平年) の往復変換。
- 1582 年付近: 1582-10-04 → 1582-10-15 の連続性、および BC/AD 境界 (BC1-12-31 ↔ AD1-01-01)。
- フォーマット/パース: `%Y-%m-%d`, `%E%Y%m%d`, 曜日指定子、`%%` を含むパターン、`strict` フラグの挙動。
- エラーケース: 月=13、日=0、year=0、曖昧書式などで期待どおり例外が投げられるか。

## 参考
- [グレゴリオ暦 - Wikipedia](https://ja.wikipedia.org/wiki/%E3%82%B0%E3%83%AC%E3%82%B4%E3%83%AA%E3%82%AA%E6%9A%A6#%E5%85%88%E7%99%BA%E3%82%B0%E3%83%AC%E3%82%B4%E3%83%AA%E3%82%AA%E6%9A%A6%E3%81%A8%E3%83%A6%E3%83%AA%E3%82%A6%E3%82%B9%E6%9A%A6)
# ユリウス暦カレンダー実装仕様

## ユリウス暦の特徴
- 1 年を 365 日とし、4 年ごとに閏日を追加する太陽暦。紀元前 45 年から使用され、グレゴリオ暦が導入されるまでの標準暦でした。
- 実装では **歴史的な誤差期間** (カエサル暗殺後に 3 年ごとへ誤適用された期間、および紀元 8 年以降の 4 年周期復帰) を再現しています。
- 内部表現は `Date` クラス共通のシリアル日 (1970-01-01 = 0) を用いており、他の暦法と同じ API で相互変換できます。
- `Era` は `BC`/`AD` の 2 種で、年 0 は存在しません (BC 1 年の次は AD 1 年)。

## 実装構成
### 日付計算ロジック
- `JulianCalendar::to_serial_date` は BC45-01-01 を基準シリアル (`julian_bc45_1_1_serial`) とし、年数と閏年カウントを手計算して累積日数を求めます。
	- 閏日カウントは 3 つの期間 (誤適用期 / ギャップ期 / 正常期) で式を切り替え、紀元前 45〜紀元 7 年の史実を反映します。
	- 月日計算は固定配列 + 閏日補正で行い、月ごとの日数はグレゴリオ暦と同じ 31/30/28 体系です。
- `from_serial_date` は対象期間に応じて 3 種の逆変換アルゴリズムを切り替え、BC45 以降の双方向変換を実現します。
- 曜日計算はグレゴリオ暦と同じ式 (シリアル ±4 の剰余) を再利用しています。

### フォーマット/パース機構
- `to_serial_date(const std::string&, const char*, bool)` および `parse_*` 群は `GregorianCalendar` と同じフォーマット指定子をサポートし、再帰 descent で文字列を解析します。
- 大文字指定子 (`%Y`, `%M`, `%D`) は桁数可変、⼩文字指定子 (`%y`, `%m`, `%d`) は 2 桁固定です。
- `strict` フラグは曖昧解釈の扱いを切り替えます。`strict=true` (既定) では複数候補がある場合に例外、`strict=false` では最初に成功した候補を採用します。リテラルの不一致や不要な空白は常にエラーになります。
- `from_serial_date(..., const char* format)` は `%E/%e`, `%Y/%y`, `%M/%m`, `%D/%d`, `%W/%w`, `%%` を組み合わせた文字列を生成します。

### 主なクラス
- `JulianCalendar` は `ICalendarSystem` を実装するユリウス暦変換器で、`Date` クラスの `CalendarSystem::JULIAN` から利用されます。
- `GregorianCalendar` との併用により、同一シリアル日の異なる暦法表示 (`Date::to_string`) が可能です。ユリウス暦上の 1582-10-04 の翌日は 1582-10-05 であり、グレゴリオ暦とのギャップ計算は呼び出し側で制御します。

## 実装しているもの
- BC45 から未来までの先発ユリウス暦変換 (年 0 不許可、BC/AD 切り替え対応)。
- カエサル暗殺後の誤閏周期 (3 年ごと) と紀元 8 年以降の正しい 4 年周期を含む閏年判定。
- フォーマット指定子 `%E/%e`, `%Y/%y`, `%M/%m`, `%D/%d`, `%W/%w`, `%%`。
- `strict` フラグによる曖昧一致検出と貪欲解釈の切り替え。
- 曜日名のフル/省略表示、例外メッセージでの詳細な原因提示。

## 未実装 / 制限事項
- ロケール依存の月名・ローマ数字表記・序数・ISO 週番号などの書式指定子はありません。
- 年や月、日には 1 以上の整数しか受け付けません。0 や負数を指定すると例外になります。
- `strict=false` でもリテラルの揺れ ("-"→"/") や余計な空白は許容されません。
- 紀元前 45 年より前の日付は未定義です。必要なら anchor を延ばす拡張が必要です。
- 暦改革の現地差 (たとえばロシア革命期の採用遅延) は考慮していません。純粋なユリウス暦の連続計算のみを提供します。

## 使い方
### `Date` 経由
```cpp
#include <Date.hpp>

// ユリウス暦 1582-10-04 を表す Date を生成
toolbox::Date julian_date(toolbox::JULIAN,
		toolbox::JulianCalendar::AD, 1582, 10, 4);

// ユリウス暦 → 文字列
std::string s = julian_date.to_string(toolbox::JULIAN, "%E%Y-%m-%d");

// 同じシリアル日をグレゴリオ暦で表示
std::string greg = julian_date.to_string(toolbox::GREGORIAN, "%Y-%m-%d");
```

### `JulianCalendar` を直接利用
```cpp
#include <calendar_system/JulianCalendar.hpp>

toolbox::JulianCalendar cal;

// 元号+年月日をシリアルへ (BC 44-02-29)
int serial = cal.to_serial_date(toolbox::JulianCalendar::BC,
															 44, 2, 29);

// 文字列パース (strict=false で先にマッチした解釈を採用)
serial = cal.to_serial_date("A.D.0080/1/2", "%E%Y/%M/%D", false);

// シリアル→文字列 (曜日付き)
std::string out;
cal.from_serial_date(serial, out, "%E%Y-%m-%d (%w)");

// シリアル→個別要素
int era, year, month, day;
cal.from_serial_date(serial, era, year, month, day);
```

## フォーマット仕様
| 指定子 | 入出力 | 説明 |
| --- | --- | --- |
| `%E` / `%e` | 双方向 | `BC`/`AD`。`%E` は "B.C."/"A.D.", `%e` は "BC"/"AD" |
| `%Y` | 双方向 | 年 (可変長、ゼロ埋めなし)。BC の場合も正の整数で指定。 |
| `%y` | 双方向 | 年の下 2 桁 (ゼロ埋め)。 |
| `%M` / `%m` | 双方向 | 月。`%M` は可変長、`%m` は 2 桁ゼロ埋め。 |
| `%D` / `%d` | 双方向 | 日。`%D` は可変長、`%d` は 2 桁ゼロ埋め。 |
| `%W` / `%w` | 出力のみ | 曜日 (フルスペル / 省略形)。 |
| `%%` | 双方向 | リテラル `%`。 |

- フォーマット中のリテラル (区切り文字や空白) は完全一致が必要です。
- 可変長指定子を連続させると曖昧解釈が発生しやすいので、区切り文字の挿入を推奨します。

## 特殊処理と注意事項
- **カエサル期の閏年**: BC45〜紀元 7 年は実史の誤閏処理を再現しており、通常の 4 年周期と一致しません。入力値も同じ規則で検証されます。
- **年 0 不許可**: `to_serial_date` は year<=0 で例外を投げます。BC 年を扱う際は 1, 2, ... を指定してください。
- **曖昧書式と strict**: `%Y%m%d` など複数解を生むフォーマットでは、`strict=true` (デフォルト) がエラー、`strict=false` が最初の解釈を返します。
- **異暦とのズレ**: 1582-10-15 以降はグレゴリオ暦と日数差が広がるため、同じシリアル日でもユリウス暦表示は世界標準の日付と異なる点に注意してください。
- **対応範囲**: 実装は BC45 以降を対象としており、それ以前のシリアル値を渡すと計算が未定義になります。

## 改変・拡張のヒント
- **追加フォーマット**: 月名やローマ数字表記を追加する場合は `to_string_*` / `parse_*` を拡張します。
- **範囲拡張**: BC45 より前を扱う必要がある場合、基準シリアルや閏年カウント式のケース分けを追加してください。
- **性能改善**: `parse_formatted_date` は再帰実装のため、大量パース時にスタックが深くなる可能性があります。iterative 化で最適化できます。
- **並行利用**: Julian ↔ Gregorian 変換の差分日数 (現在は固定 13 日) を利用するヘルパーを用意するとアプリ側での補正が容易になります。

## テスト観点
- 閏年検証: BC 45, BC 44, BC 41, BC 8, AD 8, AD 12, AD 16 など誤閏期と正常期の境界。
- 曖昧パース: `"1112" + "%M1%D"` など strict フラグの挙動確認。
- BC/AD 境界: BC1-12-31 ↔ AD1-01-01 の往復変換。
- クロスチェック: 同じシリアル日をグレゴリオ暦と比較して想定どおり日付差が生じるか。

## 参考
- [ユリウス暦 - Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%A6%E3%83%AA%E3%82%A6%E3%82%B9%E6%9A%A6)


